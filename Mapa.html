<!DOCTYPE html>
<html lang="es">
<head>

   vedRoutes = JSON.parse(localStorage.getItem('savedRoutes')) || [];
      const route = savedRoutes[index];
      if (route && confirm(`쮼st치s seguro de que deseas eliminar la ruta "${route.name}"?`)) {
        savedRoutes.splice(index, 1);
        localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
        loadSavedRoutes();
      }
    }
    
    // Funciones para guardar ubicaciones puntuales
function cargarPuntosGuardados() {
  const savedLocations = JSON.parse(localStorage.getItem('savedLocations')) || [];
  savedLocations.forEach((loc, index) => {
    const puntoNumero = index + 1;
    const customIcon = L.divIcon({
      className: 'custom-icon',
      html: `
        <div style="position: relative;">
          <img src="https://raw.githubusercontent.com/Chatlas2023/Iconos/main/Auto_Rojo.png" style="width: 50px; height: 50px;">
          <div style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); font-size: 14px; font-weight: bold; color: black; background: white; padding: 2px 5px; border-radius: 3px; border: 1px solid #ccc;">
            ${puntoNumero}
          </div>
        </div>
      `,
      iconSize: [50, 50],
      iconAnchor: [25, 50],
      popupAnchor: [-35, -40]
    });

    const newMarker = L.marker([loc.lat, loc.lon], {
      title: loc.nombre,
      icon: customIcon
    }).addTo(map);

    const popupContent = `
      <div style="white-space: nowrap;">
        <label for="nombrePunto">Nombre:</label>
        <input type="text" id="nombrePunto" value="${loc.nombre}" style="width: 120px;"><br><br>
        <div>Latitud: ${loc.lat.toFixed(6)}</div>
        <div>Longitud: ${loc.lon.toFixed(6)}</div><br>
        <button onclick="cambiarNombre(this)" style="margin-left: 5px;">Cambiar Nombre</button>
        <button onclick="eliminarPunto(this)" style="margin-left: 5px;">Quitar</button><br><br>
        <button onclick="compartirCoordenadas(${loc.lat}, ${loc.lon}, document.getElementById('nombrePunto').value)" style="margin-left: 5px;">Compartir por WhatsApp</button>
      </div>
    `;

    newMarker.bindPopup(popupContent);
    savedMarkers.push(newMarker);
  });
}

    function actualizarLocalStoragePuntos() {
      const savedLocations = savedMarkers.map((marker, index) => {
        const latLng = marker.getLatLng();
        const nombre = marker.getPopup()._content.match(/value="([^"]+)"/)[1];
        return { lat: latLng.lat, lon: latLng.lng, nombre: nombre };
      });
      localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
    }

    function actualizarNumerosPuntos() {
      savedMarkers.forEach((m, i) => {
        const puntoNumero = i + 1;
const customIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/Chatlas2023/Iconos/main/Auto_Rojo.png',
  iconSize: [40, 40],           // Tama침o de la imagen (ajusta seg칰n necesites)
  iconAnchor: [20, 40],          // Punto de anclaje del icono (centro inferior)
  popupAnchor: [-35, -40],         // Ajuste del popup (arriba del icono)
  className: 'numbered-marker'   // Clase CSS opcional para estilos adicionales
});
        m.setIcon(customIcon);

        const popupContent = `
          <div style="white-space: nowrap;">
            <label for="nombrePunto">Nombre:</label>
            <input type="text" id="nombrePunto" value="Punto ${puntoNumero}" style="width: 120px;"><br><br>
            <div>Latitud: ${m.getLatLng().lat.toFixed(6)}</div>
            <div>Longitud: ${m.getLatLng().lng.toFixed(6)}</div><br>
            <button onclick="cambiarNombre(this)" style="margin-left: 5px;">Cambiar Nombre</button>
            <button onclick="eliminarPunto(this)" style="margin-left: 5px;">Quitar</button><br><br>
            <button onclick="compartirCoordenadas(${m.getLatLng().lat}, ${m.getLatLng().lng})" style="margin-left: 5px;">Compartir por WhatsApp</button>
          </div>
        `;

        m.setPopupContent(popupContent);
      });
    }

function guardarUbicacion() {
  if (currentLat && currentLon) {
    const puntoNumero = savedMarkers.length + 1;
    const customIcon = L.divIcon({
      className: 'custom-icon',
      html: `
        <div style="position: relative;">
          <img src="https://raw.githubusercontent.com/Chatlas2023/Iconos/main/Auto_Rojo.png" style="width: 50px; height: 50px;">
          <div style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); font-size: 14px; font-weight: bold; color: black; background: white; padding: 2px 5px; border-radius: 3px; border: 1px solid #ccc;">
            ${puntoNumero}
          </div>
        </div>
      `,
      iconSize: [50, 50],
      iconAnchor: [25, 50],
      popupAnchor: [-35, -40]
    });

    const newMarker = L.marker([currentLat, currentLon], {
      title: "Punto",
      icon: customIcon
    }).addTo(map).setDataNumber(puntoNumero);

    savedMarkers.push(newMarker);

    const popupContent = `
      <div style="white-space: nowrap;">
        <label for="nombrePunto">Nombre:</label>
        <input type="text" id="nombrePunto" value="Punto ${puntoNumero}" style="width: 120px;"><br><br>
        <div>Latitud: ${currentLat.toFixed(6)}</div>
        <div>Longitud: ${currentLon.toFixed(6)}</div><br>
        <button onclick="cambiarNombre(this)" style="margin-left: 5px;">Guardar Nombre</button>
        <button onclick="eliminarPunto(this)" style="margin-left: 5px;">Quitar</button><br><br>
        <button onclick="compartirCoordenadas(${currentLat}, ${currentLon}, document.getElementById('nombrePunto').value)" style="margin-left: 5px;">Compartir por WhatsApp</button>
      </div>
    `;

    newMarker.bindPopup(popupContent).openPopup();
    actualizarLocalStoragePuntos();
  } else {
    alert("No se ha obtenido la ubicaci칩n actual.");
  }
}

window.cambiarNombre = function(button) {
  const input = button.parentElement.querySelector('#nombrePunto');
  const newName = input.value;
  const marker = savedMarkers.find(marker => {
    const popupContent = marker.getPopup()._content;
    return popupContent.includes(button.parentElement.innerHTML.trim());
  });
  if (marker) {
    const latLng = marker.getLatLng();
    const popupContent = `
      <div style="white-space: nowrap;">
        <label for="nombrePunto">Nombre:</label>
        <input type="text" id="nombrePunto" value="${newName}" style="width: 120px;"><br><br>
        <div>Latitud: ${latLng.lat.toFixed(6)}</div>
        <div>Longitud: ${latLng.lng.toFixed(6)}</div><br>
        <button onclick="cambiarNombre(this)" style="margin-left: 5px;">Cambiar Nombre</button>
        <button onclick="eliminarPunto(this)" style="margin-left: 5px;">Quitar</button><br><br>
        <button onclick="compartirCoordenadas(${latLng.lat}, ${latLng.lng}, document.getElementById('nombrePunto').value)" style="margin-left: 5px;">Compartir por WhatsApp</button>
      </div>
    `;
    marker.setPopupContent(popupContent);
    actualizarLocalStoragePuntos();
  }
};

    window.eliminarPunto = function(button) {
      const marker = savedMarkers.find(marker => {
        const popupContent = marker.getPopup()._content;
        return popupContent.includes(button.parentElement.innerHTML.trim());
      });
      if (marker) {
        map.removeLayer(marker);
        savedMarkers = savedMarkers.filter(m => m !== marker);
        actualizarLocalStoragePuntos();
        actualizarNumerosPuntos();
      }
    };

window.compartirCoordenadas = function(lat, lon, nombrePunto = "") {
  // Usamos setTimeout para evitar que el navegador bloquee la interfaz
  setTimeout(() => {
    const googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
    const nombre = nombrePunto || `Ubicaci칩n (${lat.toFixed(6)}, ${lon.toFixed(6)})`;
    
    const mensaje = `游늸 *${nombre}* 游늸\n\n游댳 *Coordenadas:* ${lat.toFixed(6)}, ${lon.toFixed(6)}\n\n游깴 Ver en Google Maps: ${googleMapsLink}`;
    
    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(mensaje)}`;
    window.open(whatsappUrl, '_blank');
  }, 100); // Peque침o retardo para permitir que el popup se cierre
};
    // Inicializaci칩n
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      if (!document.getElementById('windy-script')) {
        const windyScript = document.createElement('script');
        windyScript.id = 'windy-script';
        windyScript.src = 'https://api.windy.com/assets/map-forecast/libBoot.js';
        document.head.appendChild(windyScript);
      }
      
      loadCoordinates();
      loadMapWithSavedCoordinates();
      document.getElementById('distanceValue').textContent = totalDistance.toFixed(1);
      getLocation();
      applyDarkModePreference();
      loadSavedRoutes();
      cargarPuntosGuardados();
      
      // Cargar 칰ltimo barrio guardado
      const savedNeighborhood = localStorage.getItem('lastNeighborhood');
      if (savedNeighborhood) {
        lastKnownNeighborhood = savedNeighborhood;
        updateNeighborhoodName(savedNeighborhood);
      }

      // Event listeners
document.getElementById('clearButton').addEventListener('click', startNewRoute);
document.getElementById('stopButton').addEventListener('click', toggleCapture);
document.getElementById('shareButton').addEventListener('click', shareViaWhatsApp);
document.getElementById('darkModeButton').addEventListener('click', toggleDarkMode);
document.getElementById('saveRouteButton').addEventListener('click', saveRoute);
document.getElementById('saveLocation').addEventListener('click', guardarUbicacion);
document.getElementById('layerToggleButton').addEventListener('click', function(e) {
    e.preventDefault();
    toggleMapLayer();
      });
      document.getElementById("saveLocation").addEventListener("click", guardarUbicacion);

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        if (isCapturing) {
            toggleCapture();
            wasCapturingBeforeHidden = true;
        }
        releaseWakeLock();
    } else if (wasCapturingBeforeHidden) {
        toggleCapture();
        wasCapturingBeforeHidden = false;
    }
      });
    });
  </script>
</body>
</html>
