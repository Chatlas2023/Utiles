<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årboles de Buenos Aires</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: hsl(0, 0%, 94%);
            color: black;
        }
        #map {
            width: 100%;
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 5px;
            position: relative;
        }
        #controls {
            padding: 10px;
            background-color: #f7faca;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        #search {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
            flex-grow: 1;
            max-width: 300px;
        }
        #speciesFilter, #comunaFilter {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: white;
        }
        button {
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            transition: background-color 0.3s;
        }
        #toggleClusters {
            background-color: #4caf50;
        }
        #toggleClusters:hover {
            background-color: #3e8e41;
        }
        #darkModeButton {
            background-color: #333;
        }
        #darkModeButton:hover {
            background-color: #555;
        }
        #infoPanel {
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            margin: 1px 10px;
            border-radius: 8px;
        }
        #treeCount {
            font-weight: bold;
            margin-bottom: 5px;
        }
        #speciesList {
            font-size: 14px;
            color: #555;
        }
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        body.dark-mode #controls {
            background-color: #444;
        }
        body.dark-mode #search,
        body.dark-mode #speciesFilter,
        body.dark-mode #comunaFilter {
            background-color: #333;
            color: white;
            border-color: #555;
        }
        body.dark-mode #infoPanel {
            background: rgba(40, 40, 40, 0.9);
            border-top-color: #555;
        }
        body.dark-mode #speciesList {
            color: #bbb;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            z-index: 1000;
            max-width: 250px;
        }
        body.dark-mode .legend {
            background: #333;
            color: white;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
        .species-1 { background-color: #4caf50; } /* Tipuana tipu */
        .species-2 { background-color: #2196f3; } /* Fraxinus */
        .species-3 { background-color: #ff9800; } /* Jacaranda */
        .species-4 { background-color: #9c27b0; } /* Peltophorum */
        .species-5 { background-color: #f44336; } /* Otras especies */
        .species-6 { background-color: #ffeb3b; } /* Platanus */
        .species-7 { background-color: #00bcd4; } /* Citrus */
        .species-8 { background-color: #8bc34a; } /* Otras */
        
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.6);
        }
        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.6);
        }
        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.6);
        }
        
        /* Estilos para m√≥viles */
        @media (max-width: 768px) {
            #controls {
                flex-direction: column;
                align-items: stretch;
            }
            #search, #speciesFilter, #comunaFilter {
                max-width: none;
            }
            .legend {
                max-width: 200px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="map">
        <div id="layerControl" class="leaflet-bar leaflet-control" style="position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.4);">
            <a href="#" title="Cambiar tipo de mapa" id="layerToggleButton">üåç</a>
        </div>
        <div class="legend">
            <h4 style="margin-top: 0; font-size: 14px;">Leyenda - Especies</h4>
            <div class="legend-item">
                <div class="legend-color species-1"></div>
                <span>Tipuana tipu</span>
            </div>
            <div class="legend-item">
                <div class="legend-color species-2"></div>
                <span>Fraxinus</span>
            </div>
            <div class="legend-item">
                <div class="legend-color species-3"></div>
                <span>Jacaranda</span>
            </div>
            <div class="legend-item">
                <div class="legend-color species-4"></div>
                <span>Peltophorum</span>
            </div>
            <div class="legend-item">
                <div class="legend-color species-5"></div>
                <span>Otras especies</span>
            </div>
        </div>
    </div>
    
    <div id="controls">
        <input type="text" id="search" placeholder="Buscar por especie o calle...">
        <select id="speciesFilter">
            <option value="all">Todas las especies</option>
        </select>
        <select id="comunaFilter">
            <option value="all">Todas las comunas</option>
        </select>
        <button id="toggleClusters">Agrupar √°rboles</button>
        <button id="darkModeButton">Modo oscuro</button>
    </div>
    
    <div id="infoPanel">
        <div id="treeCount">Cargando √°rboles...</div>
        <div id="speciesList"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        // Variables globales
        let map, treesLayer, markersCluster;
        let allTrees = [];
        let useClusters = true;
        let currentLayerIndex = 0;
        const layerTypes = ['osm', 'satellite'];
        const layerIcons = ['üåç', 'üõ∞Ô∏è'];

        // Mapeo de especies a colores
        const speciesColorMap = {
            'Tipuana tipu': '#4caf50',
            'Fraxinus pennsylvanica': '#2196f3',
            'Fraxinus excelsior': '#2196f3',
            'Fraxinus americana': '#2196f3',
            'Jacaranda mimosifolia': '#ff9800',
            'Jacaranda': '#ff9800',
            'Peltophorum dubium': '#9c27b0',
            'Platanus x hispanica': '#ffeb3b',
            'Platanus acerifolia': '#ffeb3b',
            'Platanus orientalis': '#ffeb3b',
            'Citrus x aurantium': '#00bcd4',
            'Citrus sinensis': '#00bcd4',
            'default': '#f44336'
        };

        // Mapeo de especies a clases CSS
        const speciesClassMap = {
            'Tipuana tipu': 'species-1',
            'Fraxinus pennsylvanica': 'species-2',
            'Fraxinus excelsior': 'species-2',
            'Fraxinus americana': 'species-2',
            'Jacaranda mimosifolia': 'species-3',
            'Jacaranda': 'species-3',
            'Peltophorum dubium': 'species-4',
            'Platanus x hispanica': 'species-5',
            'Platanus acerifolia': 'species-5',
            'Platanus orientalis': 'species-5',
            'Citrus x aurantium': 'species-6',
            'Citrus sinensis': 'species-6',
            'default': 'species-7'
        };

        // Capas del mapa
        let layers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            })
        };

        // Inicializar el mapa
        function initMap() {
            // Centrar en Buenos Aires
            map = L.map('map').setView([-34.6037, -58.3816], 13);
            layers.osm.addTo(map);
            
            // Inicializar el cluster de marcadores
            markersCluster = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: true,
                zoomToBoundsOnClick: true
            });
            
            // Cargar datos de √°rboles
            loadTreeData();
        }

        // Funci√≥n para cargar datos de √°rboles
        async function loadTreeData() {
            try {
                // URL de tu GeoJSON - actualiza esta URL con la ubicaci√≥n real de tu archivo
                const response = await fetch('https://raw.githubusercontent.com/Chatlas2023/Capas_Json/main/arbolado.json');
                const treeData = await response.json();
                
                allTrees = treeData.features;
                
                // Procesar y mostrar √°rboles
                processTrees(allTrees);
                
                // Actualizar estad√≠sticas
                updateTreeStats();
                
                // Cargar filtros
                loadSpeciesFilter();
                loadComunaFilter();
                
            } catch (error) {
                console.error('Error cargando datos de √°rboles:', error);
                document.getElementById('treeCount').textContent = 'Error cargando datos de √°rboles';
            }
        }

        // Funci√≥n para procesar y mostrar √°rboles
        function processTrees(trees) {
            // Limpiar capas existentes
            if (treesLayer) {
                map.removeLayer(treesLayer);
            }
            if (markersCluster) {
                markersCluster.clearLayers();
            }
            
            // Crear capa de √°rboles
            treesLayer = L.geoJSON(null, {
                pointToLayer: function(feature, latlng) {
                    // Obtener informaci√≥n del √°rbol
                    const props = feature.properties;
                    const species = props.nombre_cientifico || 'Especie no identificada';
                    const color = getSpeciesColor(species);
                    
                    // Crear marcador personalizado
                    const marker = L.circleMarker(latlng, {
                        radius: getMarkerSize(props.diametro_altura_pecho),
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    // Agregar popup con informaci√≥n detallada
                    marker.bindPopup(createPopupContent(props));
                    
                    return marker;
                }
            });
            
            // Agregar caracter√≠sticas a la capa
            treesLayer.addData({
                type: "FeatureCollection",
                features: trees
            });
            
            // Agregar al mapa seg√∫n el modo seleccionado
            if (useClusters) {
                // Agregar marcadores al cluster
                treesLayer.eachLayer(function(layer) {
                    markersCluster.addLayer(layer);
                });
                map.addLayer(markersCluster);
            } else {
                map.addLayer(treesLayer);
            }
        }

        // Funci√≥n para determinar tama√±o del marcador seg√∫n di√°metro
        function getMarkerSize(diameter) {
            if (!diameter) return 4;
            if (diameter < 10) return 4;
            if (diameter < 30) return 6;
            if (diameter < 60) return 8;
            return 10;
        }

        // Funci√≥n para crear contenido del popup
        function createPopupContent(props) {
            return `
                <div style="min-width: 250px;">
                    <h3 style="margin: 0 0 10px 0; color: #2c3e50;">${props.nombre_cientifico || 'Especie no identificada'}</h3>
                    <div style="font-size: 14px; line-height: 1.4;">
                        <p><strong>üìç Ubicaci√≥n:</strong> ${props.direccion_normalizada || props.calle_nombre || 'No disponible'}</p>
                        <p><strong>üèõÔ∏è Comuna:</strong> ${props.comuna || 'No disponible'}</p>
                        <p><strong>üìè Di√°metro:</strong> ${props.diametro_altura_pecho ? props.diametro_altura_pecho + ' cm' : 'No disponible'}</p>
                        <p><strong>üå≥ Altura:</strong> ${props.altura_arbol ? props.altura_arbol + ' m' : 'No disponible'}</p>
                        <p><strong>üõ£Ô∏è Ancho acera:</strong> ${props.ancho_acera ? props.ancho_acera + ' m' : 'No disponible'}</p>
                        <p><strong>üìã Estado:</strong> ${props.estado_plantera || 'No disponible'}</p>
                        ${props.tipo_activ ? `<p><strong>üìù Tipo:</strong> ${props.tipo_activ}</p>` : ''}
                        ${props.nro_registro ? `<p><strong>üî¢ Registro:</strong> ${props.nro_registro}</p>` : ''}
                    </div>
                </div>
            `;
        }

        // Funci√≥n para obtener color seg√∫n especie
        function getSpeciesColor(species) {
            return speciesColorMap[species] || speciesColorMap.default;
        }

        // Funci√≥n para obtener clase CSS seg√∫n especie
        function getSpeciesClass(species) {
            return speciesClassMap[species] || speciesClassMap.default;
        }

        // Funci√≥n para actualizar estad√≠sticas
        function updateTreeStats() {
            const treeCount = allTrees.length;
            document.getElementById('treeCount').textContent = `Total de √°rboles: ${treeCount.toLocaleString()}`;
            
            // Contar especies √∫nicas
            const speciesCount = {};
            allTrees.forEach(tree => {
                const species = tree.properties.nombre_cientifico || 'Especie no identificada';
                speciesCount[species] = (speciesCount[species] || 0) + 1;
            });
            
            // Mostrar las 5 especies m√°s comunes
            const topSpecies = Object.entries(speciesCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let speciesHTML = '<strong>Especies m√°s comunes:</strong><br>';
            topSpecies.forEach(([species, count]) => {
                speciesHTML += `${species}: ${count.toLocaleString()}<br>`;
            });
            
            document.getElementById('speciesList').innerHTML = speciesHTML;
        }

        // Funci√≥n para cargar filtro de especies
        function loadSpeciesFilter() {
            const speciesFilter = document.getElementById('speciesFilter');
            
            // Obtener especies √∫nicas
            const uniqueSpecies = [...new Set(allTrees.map(tree => 
                tree.properties.nombre_cientifico || 'Especie no identificada'
            ))].sort();
            
            // Agregar opciones
            uniqueSpecies.forEach(species => {
                const option = document.createElement('option');
                option.value = species;
                option.textContent = species;
                speciesFilter.appendChild(option);
            });
        }

        // Funci√≥n para cargar filtro de comunas
        function loadComunaFilter() {
            const comunaFilter = document.getElementById('comunaFilter');
            
            // Obtener comunas √∫nicas
            const uniqueComunas = [...new Set(allTrees.map(tree => 
                tree.properties.comuna
            ).filter(comuna => comuna != null))].sort((a, b) => a - b);
            
            // Agregar opciones
            uniqueComunas.forEach(comuna => {
                const option = document.createElement('option');
                option.value = comuna;
                option.textContent = `Comuna ${comuna}`;
                comunaFilter.appendChild(option);
            });
        }

        // Funci√≥n para filtrar √°rboles
        function filterTrees() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const selectedSpecies = document.getElementById('speciesFilter').value;
            const selectedComuna = document.getElementById('comunaFilter').value;
            
            const filteredTrees = allTrees.filter(tree => {
                const props = tree.properties;
                const especie = props.nombre_cientifico || 'Especie no identificada';
                const calle = props.calle_nombre || '';
                const direccion = props.direccion_normalizada || '';
                const comuna = props.comuna;
                
                // Filtrar por especie seleccionada
                if (selectedSpecies !== 'all' && especie !== selectedSpecies) {
                    return false;
                }
                
                // Filtrar por comuna seleccionada
                if (selectedComuna !== 'all' && comuna != selectedComuna) {
                    return false;
                }
                
                // Filtrar por t√©rmino de b√∫squeda
                if (searchTerm && 
                    !especie.toLowerCase().includes(searchTerm) && 
                    !calle.toLowerCase().includes(searchTerm) && 
                    !direccion.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                return true;
            });
            
            // Actualizar √°rboles mostrados
            processTrees(filteredTrees);
            
            // Actualizar estad√≠sticas
            document.getElementById('treeCount').textContent = 
                `√Årboles mostrados: ${filteredTrees.length.toLocaleString()} de ${allTrees.length.toLocaleString()}`;
        }

        // Funci√≥n para alternar agrupaci√≥n
        function toggleClusters() {
            useClusters = !useClusters;
            document.getElementById('toggleClusters').textContent = 
                useClusters ? 'Mostrar √°rboles individuales' : 'Agrupar √°rboles';
            
            // Volver a procesar √°rboles con el nuevo modo
            filterTrees();
        }

        // Funci√≥n para cambiar capas del mapa
        function toggleMapLayer() {
            currentLayerIndex = (currentLayerIndex + 1) % layerTypes.length;
            const selectedLayer = layerTypes[currentLayerIndex];
            document.getElementById('layerToggleButton').textContent = layerIcons[currentLayerIndex];
            
            map.eachLayer(layer => {
                if (layer === layers.osm || layer === layers.satellite) {
                    map.removeLayer(layer);
                }
            });
            
            layers[selectedLayer].addTo(map);
            
            // Volver a agregar la capa de √°rboles
            if (useClusters) {
                map.addLayer(markersCluster);
            } else {
                map.addLayer(treesLayer);
            }
        }

        // Funci√≥n para alternar modo oscuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            document.getElementById('darkModeButton').textContent = 
                isDarkMode ? 'Modo claro' : 'Modo oscuro';
        }

        // Funci√≥n para aplicar preferencia de modo oscuro
        function applyDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeButton').textContent = 'Modo claro';
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            applyDarkModePreference();
            
            // Event listeners
            document.getElementById('search').addEventListener('input', filterTrees);
            document.getElementById('speciesFilter').addEventListener('change', filterTrees);
            document.getElementById('comunaFilter').addEventListener('change', filterTrees);
            document.getElementById('toggleClusters').addEventListener('click', toggleClusters);
            document.getElementById('darkModeButton').addEventListener('click', toggleDarkMode);
            document.getElementById('layerToggleButton').addEventListener('click', function(e) {
                e.preventDefault();
                toggleMapLayer();
            });
        });
    </script>
</body>
</html>
